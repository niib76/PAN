{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "vmName",
        "type": "Microsoft.Common.TextBox",
        "label": "VM Name",
        "defaultValue": "PAN-FW0x",
        "toolTip": "Name of the VM-Series firewall",
        "constraints": {
          "required": true
        }
      },
      {
        "name": "adminUsername",
        "type": "Microsoft.Compute.UserNameTextBox",
        "label": "Admin Username",
        "defaultValue": "admin",
        "toolTip": "Administrator username for the VM",
        "constraints": {
          "required": true
        },
        "osPlatform": "Linux"
      },
      {
        "name": "authenticationType",
        "type": "Microsoft.Compute.CredentialsCombo",
        "label": {
          "authenticationType": "Authentication type",
          "password": "Password",
          "confirmPassword": "Confirm password",
          "sshPublicKey": "SSH public key"
        },
        "toolTip": {
          "authenticationType": "Authentication type",
          "password": "Password for the administrator account",
          "sshPublicKey": "SSH public key for the administrator account"
        },
        "constraints": {
          "required": true
        },
        "options": {
          "hideConfirmation": false,
          "hidePassword": false
        },
        "osPlatform": "Linux"
      }
    ],
    "steps": [
      {
        "name": "vmConfig",
        "label": "VM Configuration",
        "elements": [
          {
            "name": "vmSize",
            "type": "Microsoft.Compute.SizeSelector",
            "label": "VM Size",
            "toolTip": "Select the size of the VM",
            "recommendedSizes": [
              "Standard_DS3_v2",
              "Standard_DS4_v2",
              "Standard_D8s_v3"
            ],
            "constraints": {
              "allowedSizes": [
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_D4_v3",
                "Standard_D5_v2",
                "Standard_D8_v3",
                "Standard_D8_v4",
                "Standard_D16_v3",
                "Standard_D16_v4",
                "Standard_D8s_v4",
                "Standard_D16s_v4",
                "Standard_F8s_v2",
                "Standard_F32s_v2",
                "Standard_D8s_v3",
                "Standard_D16s_v3"
              ]
            },
            "osPlatform": "Linux",
            "count": 1
          },
          {
            "name": "imageVersion",
            "type": "Microsoft.Common.DropDown",
            "label": "PAN-OS Version",
            "defaultValue": "latest",
            "toolTip": "Select the PAN-OS version",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Latest",
                  "value": "latest"
                },
                {
                  "label": "10.2.1",
                  "value": "10.2.1"
                },
                {
                  "label": "10.1.0",
                  "value": "10.1.0"
                },
                {
                  "label": "10.0.6",
                  "value": "10.0.6"
                },
                {
                  "label": "9.1.10",
                  "value": "9.1.10"
                }
              ],
              "required": true
            }
          },
          {
            "name": "zone",
            "type": "Microsoft.Common.DropDown",
            "label": "Availability Zone",
            "defaultValue": "Zone 1",
            "toolTip": "Select the availability zone for the VM",
            "constraints": {
              "allowedValues": [
                {
                  "label": "None",
                  "value": "None"
                },
                {
                  "label": "Zone 1",
                  "value": "1"
                },
                {
                  "label": "Zone 2",
                  "value": "2"
                },
                {
                  "label": "Zone 3",
                  "value": "3"
                }
              ],
              "required": true
            }
          }
        ]
      },
      {
        "name": "networkConfig",
        "label": "Network Configuration",
        "elements": [
          {
            "name": "vnetNewOrExisting",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Virtual Network",
            "defaultValue": "Existing",
            "toolTip": "Create new or use existing virtual network",
            "constraints": {
              "allowedValues": [
                {
                  "label": "New",
                  "value": "new"
                },
                {
                  "label": "Existing",
                  "value": "existing"
                }
              ],
              "required": true
            }
          },
          {
            "name": "virtualNetwork",
            "type": "Microsoft.Network.VirtualNetworkCombo",
            "label": {
              "virtualNetwork": "Virtual network",
              "subnets": "Subnets"
            },
            "toolTip": {
              "virtualNetwork": "Virtual network for the firewall",
              "subnets": "Subnets for management, untrust, and trust interfaces"
            },
            "defaultValue": {
              "name": "VNET-PAN-FWs",
              "addressPrefixSize": "/22"
            },
            "constraints": {
              "minAddressPrefixSize": "/24"
            },
            "options": {
              "hideExisting": false
            },
            "subnets": {
              "subnet0": {
                "label": "Management Subnet",
                "defaultValue": {
                  "name": "SUB-PAN-MGMT",
                  "addressPrefixSize": "/24"
                },
                "constraints": {
                  "minAddressPrefixSize": "/29",
                  "minAddressCount": 1,
                  "requireContiguousAddresses": true
                }
              },
              "subnet1": {
                "label": "Untrust Subnet",
                "defaultValue": {
                  "name": "SUB-PAN-EXT",
                  "addressPrefixSize": "/24"
                },
                "constraints": {
                  "minAddressPrefixSize": "/29",
                  "minAddressCount": 1,
                  "requireContiguousAddresses": true
                }
              },
              "subnet2": {
                "label": "Trust Subnet",
                "defaultValue": {
                  "name": "SUB-PAN-INT",
                  "addressPrefixSize": "/24"
                },
                "constraints": {
                  "minAddressPrefixSize": "/29",
                  "minAddressCount": 1,
                  "requireContiguousAddresses": true
                }
              }
            }
          },
          {
            "name": "nsgName",
            "type": "Microsoft.Common.TextBox",
            "label": "Network Security Group Name",
            "defaultValue": "NSG-PAN-FW0x-MGMT",
            "toolTip": "Name of the Network Security Group for the management interface",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "srcIPInboundNSG",
            "type": "Microsoft.Common.TextBox",
            "label": "Source IP for Management Access",
            "defaultValue": "0.0.0.0/0",
            "toolTip": "Your source public IP address for management access (CIDR notation)",
            "constraints": {
              "required": true,
              "regex": "^([0-9]{1,3}\\.){3}[0-9]{1,3}(\\/([0-9]|[1-2][0-9]|3[0-2]))?$",
              "validationMessage": "Must be a valid IP address or CIDR range"
            }
          }
        ]
      },
      {
        "name": "publicIPConfig",
        "label": "Public IP Configuration",
        "elements": [
          {
            "name": "publicIPNewOrExisting",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Public IP Address",
            "defaultValue": "Existing",
            "toolTip": "Create new or use existing public IP",
            "constraints": {
              "allowedValues": [
                {
                  "label": "New",
                  "value": "new"
                },
                {
                  "label": "Existing",
                  "value": "existing"
                }
              ],
              "required": true
            }
          },
          {
            "name": "publicIP",
            "type": "Microsoft.Network.PublicIpAddressCombo",
            "label": {
              "publicIpAddress": "Public IP address",
              "domainNameLabel": "Domain name label"
            },
            "toolTip": {
              "publicIpAddress": "Public IP address for management interface",
              "domainNameLabel": "DNS name for the public IP"
            },
            "defaultValue": {
              "publicIpAddressName": "PIP-PAN-FW0x-MGMT",
              "domainNameLabel": ""
            },
            "constraints": {
              "required": {
                "domainNameLabel": false
              }
            },
            "options": {
              "hideNone": true,
              "hideDomainNameLabel": true,
              "hideExisting": false
            }
          }
        ]
      },
      {
        "name": "bootstrap",
        "label": "Bootstrap Configuration",
        "elements": [
          {
            "name": "bootstrapEnabled",
            "type": "Microsoft.Common.OptionsGroup",
            "label": "Enable Bootstrap",
            "defaultValue": "No",
            "toolTip": "Pass bootstrap data to the VM",
            "constraints": {
              "allowedValues": [
                {
                  "label": "Yes",
                  "value": "yes"
                },
                {
                  "label": "No",
                  "value": "no"
                }
              ],
              "required": true
            }
          },
          {
            "name": "customData",
            "type": "Microsoft.Common.TextBox",
            "label": "Custom Data",
            "defaultValue": "storage-account=None,access-key=None,file-share=None,share-directory=None",
            "toolTip": "Bootstrap custom data string",
            "visible": "[equals(steps('bootstrap').bootstrapEnabled, 'yes')]",
            "constraints": {
              "required": false
            }
          }
        ]
      }
    ],
    "outputs": {
      "location": "[location()]",
      "vmName": "[basics('vmName')]",
      "adminUsername": "[basics('adminUsername')]",
      "authenticationType": "[basics('authenticationType').authenticationType]",
      "adminPassword": "[basics('authenticationType').password]",
      "adminSshKey": "[basics('authenticationType').sshPublicKey]",
      "vmSize": "[steps('vmConfig').vmSize]",
      "imageVersion": "[steps('vmConfig').imageVersion]",
      "zone": "[steps('vmConfig').zone]",
      "virtualNetworkName": "[steps('networkConfig').virtualNetwork.name]",
      "vnetNewOrExisting": "[steps('networkConfig').vnetNewOrExisting]",
      "virtualNetworkAddressPrefix": "[first(steps('networkConfig').virtualNetwork.addressPrefixes)]",
      "virtualNetworkExistingRGName": "[steps('networkConfig').virtualNetwork.resourceGroup]",
      "subnet0Name": "[steps('networkConfig').virtualNetwork.subnets.subnet0.name]",
      "subnet1Name": "[steps('networkConfig').virtualNetwork.subnets.subnet1.name]",
      "subnet2Name": "[steps('networkConfig').virtualNetwork.subnets.subnet2.name]",
      "subnet0Prefix": "[steps('networkConfig').virtualNetwork.subnets.subnet0.addressPrefix]",
      "subnet1Prefix": "[steps('networkConfig').virtualNetwork.subnets.subnet1.addressPrefix]",
      "subnet2Prefix": "[steps('networkConfig').virtualNetwork.subnets.subnet2.addressPrefix]",
      "nsgName": "[steps('networkConfig').nsgName]",
      "srcIPInboundNSG": "[steps('networkConfig').srcIPInboundNSG]",
      "publicIPNewOrExisting": "[steps('publicIPConfig').publicIPNewOrExisting]",
      "publicIPAddressName": "[steps('publicIPConfig').publicIP.name]",
      "publicIPRGName": "[steps('publicIPConfig').publicIP.resourceGroup]",
      "publicIPAllocationMethod": "[steps('publicIPConfig').publicIP.publicIPAllocationMethod]",
      "bootstrap": "[steps('bootstrap').bootstrapEnabled]",
      "customData": "[steps('bootstrap').customData]"
    }
  }
}
